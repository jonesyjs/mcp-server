services:
  git-sync:
    image: registry.k8s.io/git-sync/git-sync:v4.2.1
    container_name: git-sync
    user: "0:0"
    environment:
      - GITSYNC_REPO=https://github.com/jonesyjs/agent-specs.git
      - GITSYNC_REF=main
      - GITSYNC_ROOT=/data
      - GITSYNC_LINK=repo
      - GITSYNC_PERIOD=60s
      - GITSYNC_DEPTH=1
      - GITSYNC_ONE_TIME=false
    volumes:
      - agent-specs-data:/data
    restart: unless-stopped

  file-sync:
    image: alpine:latest
    container_name: file-sync
    command: sh -c "while true; do REALPATH=$$(readlink -f /source/repo); if [ -d \"$$REALPATH/skills\" ]; then rm -rf /dest/* /dest/.[^.]* 2>/dev/null; cp -a \"$$REALPATH/skills\"/. /dest/ 2>&1 || true; fi; sleep 5; done"
    volumes:
      - agent-specs-data:/source:ro
      - C:/mcp-server/skills:/dest
    depends_on:
      - git-sync
    restart: unless-stopped

  mcp-server:
    image: ghcr.io/jonesyjs/mcp-server:latest
    container_name: mcp-server
    ports:
      - "8223:8223"
    volumes:
      - agent-specs-data:/agent-specs:ro
    entrypoint: ["/bin/sh", "-c"]
    command: ["ln -sf /agent-specs/repo/skills /skills 2>/dev/null || true && exec npx tsx src/index.ts"]
    depends_on:
      - git-sync
    restart: unless-stopped

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    command: http mcp-server:8223 --log stdout
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    ports:
      - "4040:4040"
    depends_on:
      - mcp-server
    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - //var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=30
    restart: unless-stopped

volumes:
  agent-specs-data:
