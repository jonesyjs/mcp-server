<!DOCTYPE html>
<html>
<head>
  <title>Claude Code Session</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 16px;
      margin: 0;
      font-size: 13px;
      line-height: 1.5;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      background: #1a1a1a;
      z-index: 100;
    }
    .header-left {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .session-id {
      font-size: 11px;
      color: #666;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .session-id:hover {
      background: #333;
      color: #fff;
    }
    .elapsed {
      font-size: 13px;
      color: #4a9eff;
      font-weight: 500;
    }
    .status {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .status.connecting { background: #3a3a1e; color: #ffd700; }
    .status.connected { background: #1e5f1e; color: #4ade80; }
    .status.disconnected { background: #5f1e1e; color: #f87171; }
    .status.complete { background: #1e3a5f; color: #60a5fa; }
    .status.error { background: #5f1e1e; color: #f87171; }

    #events {
      padding-bottom: 80px;
    }
    .event {
      margin: 6px 0;
      padding: 10px 12px;
      border-radius: 6px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .system {
      background: #252525;
      color: #666;
      font-size: 11px;
      padding: 6px 10px;
    }
    .assistant {
      background: #2d2d2d;
      border-left: 3px solid #8b5cf6;
    }
    .tool_use {
      background: #1e2a3a;
      border-left: 3px solid #3b82f6;
    }
    .tool_use .tool-name {
      color: #60a5fa;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .tool_use .tool-input {
      color: #94a3b8;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .tool_result {
      background: #1a1f1a;
      border-left: 3px solid #22c55e;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .tool_result.expanded {
      max-height: none;
    }
    .tool_result:not(.expanded)::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(transparent, #1a1f1a);
      pointer-events: none;
    }
    .tool_result .expand-hint {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 10px;
      color: #666;
      background: #1a1f1a;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .tool_result.expanded .expand-hint { display: none; }

    .result-success {
      background: #1a2f1a;
      border-left: 3px solid #22c55e;
    }
    .result-success .result-header {
      color: #4ade80;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .result-error {
      background: #2f1a1a;
      border-left: 3px solid #ef4444;
    }
    .result-error .result-header {
      color: #f87171;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .result-stats {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 16px;
      background: linear-gradient(transparent, #1a1a1a 20%);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    .btn-cancel {
      background: #5f2a2a;
      color: #f87171;
    }
    .btn-cancel:hover {
      background: #7f3a3a;
    }
    .btn-cancel:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-state .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #333;
      border-top-color: #4a9eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="status connecting" id="status">Connecting</span>
      <span class="elapsed" id="elapsed">0:00</span>
    </div>
    <span class="session-id" id="sessionId" onclick="copySessionId()" title="Click to copy">Loading...</span>
  </div>

  <div id="events">
    <div class="empty-state" id="emptyState">
      <div class="spinner"></div>
      <div>Waiting for Claude Code...</div>
    </div>
  </div>

  <div class="footer">
    <button class="btn btn-cancel" id="cancelBtn" onclick="cancelSession()">Cancel Session</button>
  </div>

  <script>
    const sessionId = new URLSearchParams(location.search).get('session');
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${location.host}/ws?session=${sessionId}`;
    let ws;
    let startTime = null;
    let elapsedInterval;
    let hasReceivedEvents = false;

    document.getElementById('sessionId').textContent = sessionId || 'No session';

    function updateElapsed() {
      if (!startTime) return;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('elapsed').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function connect() {
      updateStatus('connecting');
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        updateStatus('connected');
      };

      ws.onclose = () => {
        updateStatus('disconnected');
        // Reconnect after 2 seconds
        setTimeout(connect, 2000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
      };

      ws.onmessage = (e) => {
        try {
          const event = JSON.parse(e.data);
          handleEvent(event);
        } catch (err) {
          console.error('Failed to parse event:', err);
        }
      };
    }

    function updateStatus(s) {
      const el = document.getElementById('status');
      el.textContent = s.charAt(0).toUpperCase() + s.slice(1);
      el.className = 'status ' + s;

      // Disable cancel button when complete or error
      const cancelBtn = document.getElementById('cancelBtn');
      if (s === 'complete' || s === 'error') {
        cancelBtn.disabled = true;
      }
    }

    function hideEmptyState() {
      if (!hasReceivedEvents) {
        hasReceivedEvents = true;
        document.getElementById('emptyState').style.display = 'none';
      }
    }

    function addEvent(className, content) {
      hideEmptyState();

      if (!startTime) {
        startTime = Date.now();
        elapsedInterval = setInterval(updateElapsed, 1000);
      }

      const el = document.createElement('div');
      el.className = 'event ' + className;

      if (typeof content === 'string') {
        el.textContent = content;
      } else {
        el.innerHTML = content;
      }

      // Add click-to-expand for tool results
      if (className === 'tool_result') {
        el.innerHTML += '<span class="expand-hint">Click to expand</span>';
        el.onclick = () => el.classList.toggle('expanded');
      }

      document.getElementById('events').appendChild(el);
      el.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function handleEvent(e) {
      // Server events
      if (e.type === 'server') {
        if (e.event === 'connected') {
          // Connection confirmed, already handled by ws.onopen
          return;
        }
        if (e.event === 'disconnected' || e.event === 'killed' || e.event === 'error') {
          updateStatus('disconnected');
          addEvent('system', `Session ended: ${e.reason || e.message || e.event}`);
          return;
        }
        return;
      }

      // System init
      if (e.type === 'system' && e.subtype === 'init') {
        addEvent('system', `Session initialized | Model: ${e.model || 'unknown'}`);
        return;
      }

      // Assistant message (may contain text or tool_use)
      if (e.type === 'assistant' && e.message?.content) {
        for (const item of e.message.content) {
          if (item.type === 'text') {
            addEvent('assistant', escapeHtml(item.text));
          } else if (item.type === 'tool_use') {
            const input = typeof item.input === 'string'
              ? item.input
              : JSON.stringify(item.input, null, 2);
            addEvent('tool_use',
              `<div class="tool-name">[${escapeHtml(item.name)}]</div>` +
              `<div class="tool-input">${escapeHtml(input)}</div>`
            );
          }
        }
        return;
      }

      // User message (tool results)
      if (e.type === 'user' && e.message?.content) {
        for (const item of e.message.content) {
          if (item.type === 'tool_result') {
            const output = item.content || e.tool_use_result?.stdout || '';
            addEvent('tool_result', escapeHtml(output));
          }
        }
        return;
      }

      // Final result
      if (e.type === 'result') {
        clearInterval(elapsedInterval);

        if (e.subtype === 'success') {
          updateStatus('complete');
          const duration = e.duration_ms ? (e.duration_ms / 1000).toFixed(1) : '?';
          const cost = e.total_cost_usd ? '$' + e.total_cost_usd.toFixed(4) : '';
          addEvent('result-success',
            `<div class="result-header">Complete</div>` +
            `<div>${escapeHtml(e.result || '')}</div>` +
            `<div class="result-stats">${duration}s | ${cost}</div>`
          );
        } else {
          updateStatus('error');
          addEvent('result-error',
            `<div class="result-header">Error</div>` +
            `<div>${escapeHtml(e.result || e.error || 'Unknown error')}</div>`
          );
        }
        return;
      }

      // Unknown event - show raw JSON
      addEvent('system', escapeHtml(JSON.stringify(e)));
    }

    function copySessionId() {
      navigator.clipboard.writeText(sessionId).then(() => {
        const el = document.getElementById('sessionId');
        const original = el.textContent;
        el.textContent = 'Copied!';
        setTimeout(() => el.textContent = original, 1000);
      });
    }

    function cancelSession() {
      if (confirm('Cancel this session? The Claude Code process will be terminated.')) {
        fetch(`/api/kill?session=${sessionId}`, { method: 'POST' })
          .then(() => {
            updateStatus('complete');
            addEvent('system', 'Session cancelled by user');
          })
          .catch(err => {
            console.error('Failed to cancel:', err);
          });
      }
    }

    // Start connection
    if (sessionId) {
      connect();
    } else {
      document.getElementById('emptyState').innerHTML = '<div style="color: #f87171;">No session ID provided</div>';
    }
  </script>
</body>
</html>
